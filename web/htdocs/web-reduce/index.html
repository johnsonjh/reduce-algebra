<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/ico" href="/favicon.ico" />
    <link href="StyleSheet.css" rel="stylesheet" type="text/css" />
    <title>Web REDUCE</title>
    <style type="text/css">
        #OutputDiv, textarea {
            width: 100%
        }

        #OutputDiv {
            border: medium #000000 solid;
            height: 20em;
            resize: both;
            overflow: auto;
        }

            #OutputDiv > pre {
                margin: 0;
            }

        .buttons {
            display: flex;
            justify-content: space-evenly;
        }
    </style>
    <script>
        MathJax = {
            tex: {
                macros: { "*": "\\," }
            }
        };
    </script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
</head>
<body>
    <h1>Web REDUCE</h1>
    <p class="center">
        <a href="about.html" target="_blank" title="Opens in a new tab.">About Web REDUCE</a>
    </p>
    <p class="center">
        <label for="TypesetMathsCheckbox">Typeset Maths</label><input id="TypesetMathsCheckbox" type="checkbox" checked="checked" disabled="disabled" />
        &emsp;
        <label for="CentreTypesetMathsCheckbox">Centre Typeset Maths</label><input id="CentreTypesetMathsCheckbox" type="checkbox" checked="checked" />
    </p>
    <p>
        <label for="OutputDiv"><strong>Input/Output Display</strong></label>
    </p>
    <div id="OutputDiv">
        REDUCE is loading. Please wait...
    </div>
    <p>
        <label for="InputTextArea"><strong>Input Editor</strong></label>
    </p>
    <textarea id="InputTextArea" rows="5"></textarea>
    <p class="buttons">
        <button id="EarlierButton" type="button" disabled="disabled" title="Select earlier keyboard input. Keyboard Shortcut: Control+UpArrow.">▲ Earlier Input</button>
        <button id="SendButton" type="button" title="Send the input above to REDUCE, terminating with a semicolon if necessary. Keyboard Shortcut: Control+Enter. (Also hold Shift to prevent auto-termination.)">Send Input</button>
        <button id="LaterButton" type="button" disabled="disabled" title="Select later keyboard input. Keyboard Shortcut: Control+DownArrow.">▼ Later Input</button>
    </p>
    <a href="https://www.mathjax.org">
        <img title="Powered by MathJax"
            src="https://www.mathjax.org/badge/badge.gif"
            alt="Powered by MathJax" style="float: right" />
    </a>
    <script>
        // Set up access to document elements and reset their defaults for when the page is reloaded:
        const typesetMathsCheckbox = document.getElementById('TypesetMathsCheckbox');
        const centreTypesetMathsCheckbox = document.getElementById('CentreTypesetMathsCheckbox');
        const outputDiv = document.getElementById('OutputDiv');
        const inputTextArea = document.getElementById('InputTextArea');
        inputTextArea.value = "";
        inputTextArea.focus();
        const earlierButton = document.getElementById('EarlierButton');
        earlierButton.disabled = true;
        const sendButton = document.getElementById('SendButton');
        const laterButton = document.getElementById('LaterButton');
        laterButton.disabled = true;
        let noOutput = true, hideOutput = false;

        /**
         * Scroll the REDUCE output to the bottom.
         * A sufficient delay seems necessary for the input to be rendered!
         * This may not be the best solution but it seems to work provided the delay is long enough.
         */
        function scrollOutputDivToBottom() {
            setTimeout(function () { outputDiv.lastChild.scrollIntoView(false) }, 300);
            // Scroll again after KaTeX has had time to complete:
            setTimeout(function () { outputDiv.lastChild.scrollIntoView(false) }, 1000);
        }

        function sendToOutputDiv(text) {
            if (noOutput) {
                outputDiv.textContent = "";
                typesetMathsCheckbox.disabled = false;
                noOutput = false;
            }
            // For now, append text within a <pre> element:
            const pre = document.createElement("pre");
            pre.innerText = text;
            outputDiv.appendChild(pre);
            scrollOutputDivToBottom();
        }

        const worker = new Worker('./reduce.web.js');
        worker.onmessage = function (event) {
            if (hideOutput) { // hide changes of switches etc.
                hideOutput = false;
                return;
            }
            if (event.data.channel === 'stdout') {
                let output = event.data.line;
                // If an empty string is passed (ie asking for a blank line of output)
                // it gets lost in the display, so output a single space character.
                if (output == '') {
                    console.log("OUTPUT: Empty line"); // for debugging
                    sendToOutputDiv(' ');
                    return;
                }
                console.log(`OUTPUT: ${output}`); // for debugging

                // The mathematical part of the output delived by REDUCE will have the form:
                // latex:\black$\displaystyle\frac{-2\*\arctan\left(x\right)+\log\left(x-1\right)-\log\left(x+1\right)}{4}$
                // delimited by a pair of control characters, \u0002 before and \u0005 after.
                // The TeX in the middle is extracted and MathJax formats it.

                // Detect the case where the output line contains some TeX:
                let n = output.indexOf('\u0002');
                if (n != -1) {
                    // Here I not only strip out the material before the "U+0002" but also the
                    // "junk" that reads "latex:\black$\displaystyle" and a final "U+0005".
                    // Those are fragments that the REDUCE interface for TeXmacs inserts.
                    output = output.substring(n + 1 + 26, output.length - 2);
                    outputDiv.appendChild(MathJax.tex2chtml(output));
                    // The MathJax documentation doesn't tell the whole story!
                    // See https://github.com/mathjax/MathJax/issues/2365:
                    MathJax.startup.document.clear();
                    MathJax.startup.document.updateDocument();
                    scrollOutputDivToBottom();
                }
                else {
                    // Textual rather than mathematical output from REDUCE gets inserted as is.
                    sendToOutputDiv(output);
                }
            }
        }

        function sendToReduce(str) {
            console.log(` INPUT: ${str}`); // for debugging
            // This function posts a string to REDUCE, which treats it rather as if
            // it had been keyboard input. At the start of a run I use this to send a
            // sequence of commands to REDUCE to adjust its input and output processing
            // to suit the needs I have here.
            const buf = new Uint8Array(str.length + 1);
            for (let i = 0; i < str.length; i++)
                buf[i] = str.charCodeAt(i);
            buf[str.length] = 0; // null-terminate for benefit of C/C++.
            worker.postMessage({
                funcName: 'insert_buffer',
                callbackId: '',
                data: buf
            });
        }

        sendToReduce('<< lisp (!*redefmsg := nil); load_package tmprint;' +
            ' on nat; on fancy; off int >>$');

        // ****************
        // User Interaction
        // ****************

        typesetMathsCheckbox.addEventListener("change", event => {
            hideOutput = true;
            if (typesetMathsCheckbox.checked) sendToReduce('on fancy;');
            else sendToReduce('off fancy;');
        });

        centreTypesetMathsCheckbox.addEventListener("change", event => {
            if (centreTypesetMathsCheckbox.checked) MathJax.config.chtml.displayAlign = 'center';
            else MathJax.config.chtml.displayAlign = 'left';
            MathJax.startup.getComponents(); // See http://docs.mathjax.org/en/latest/web/configuration.html
        });
    </script>
    <script src="InputEditor.js"></script>
</body>
</html>
