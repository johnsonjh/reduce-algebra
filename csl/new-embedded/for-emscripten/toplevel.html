<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width">
    <title>Test of Reduce web-interface</title>
    <!-- This web page is a CRUDE demonstration of Reduce being able to run
         as a web application. Reduce itself is compiled using emscripten
         and ends up mostly as Wasm code which runs acceptably fast. The
         Reduce interaface here provides two rectangular panes and a "submit"
         button. You can type a Reduce command into the input pane and when
         you clock on "submit" that live is passed to Reduce which sends
         its output to the other window. You may need to scroll that window
         to see the output. The input windows is pre-populated with the text
         "int(1/(x^4-1), x);" so you can either edit or replace that or just
         press submit. The mathematical part of the output as delived by
         Reduce w will be:
           latex:\black$\displaystyle
           \frac{-2\*\arctan\left(x\right)+\log\left(x-1\right)-
           \log\left(x+1\right)}{4}$
         and that should be delimited by a pair of control characters,
         \U0002 before and \U005 after it. Other output is to be viewed as
         plain text. Note that the MathJax dislikes the use of "\*", so
         I edit that out.

         Because this page loads the various web tools it may take a while
         to load!
    -->
    <!-- This sample web-page includes instances of various external
         packages that we may wish to use. Here I load MathJax, which
         is a widely-used component for rendering TeX onto a web page.
    -->
    <!--
       <script src="https://polyfill.io/v3/polyfill.min.js?features=es6">
       </script>
    -->
    <script>
       MathJax = {
          chtml: { displayAlign: 'left' }
       };
    </script>
    <script type="text/javascript" async
       src="./tex-chtml.js">
    </script>
    <!-- Another component that we are investigating is mathlive, which
         supports an input editor for maths as well as a rendering
         capability. I hope that somebody with better HTML and Javascript
         skills than I have will help plug these into the Reduce interface
         and arrange that the page as a whole is pretty! Please post to
         the sourceforge mailing list or send a private message if you have
         a go at that.
    -->
    <!--
       <script src="https://unpkg.com/mathlive/dist/mathlive.min.js">
       </script>
       <script type="module">
          import { renderMathInDocument } from
             'https://unpkg.com/mathlive/dist/mathlive.min.mjs';
          renderMathInDocument();
       </script>
    -->
    <script>
        // add textareas + button
        window.reduceLatch = 0;

        let inArea = document.createElement('textarea');
        inArea.cols = 80;
        inArea.rows = 10;
        inArea.setAttribute('id', 'reduce-input');
        inArea.value = 'int(1/(x^4-1), x);';

        let button = document.createElement('button');
        button.appendChild(document.createTextNode('Submit'));
        let worker = new Worker('./reduce.web.js');
        worker.onmessage = function(event) {
            if (event.data.channel === 'stdout') {
                let o = event.data.line;
// If an empty string is passed (ie asking for a blank line of output)
// console.log displays an <empty string> message that I view as ugly, so
// I map blank lines into ones consisting of a single space character.
                if (o == '') o = ' ';
                console.log(o);   // For debugging...
                let n = o.indexOf('\002');
                var body = document.getElementById("theBody");
                if (n != -1)
                {
// Here I not only strip out the material before the "\002" but also the
// "junk" that reads "latex:\black$\displaystyle" and a final "$\005". Those
// are fragments that the Reduce interface for TeXmacs inserts.
                    o = o.substring(n+1+26, o.length-2)
// Reduce puts in "\*" for multiplication, but MathJax does not like that,
// so I define it away into a narrow space.
                    o = '$$'.concat(o.replace(/\\\*/g, '\\,'), '$$');
                    var para = document.createElement("P");
                    var node = document.createTextNode(o);
                    para.appendChild(node);
                    MathJax.typesetPromise([para]);
                    body.insertBefore(para, inArea);
                }
                else
                {   var para = document.createElement("P");
                    var node = document.createTextNode(o);
                    para.appendChild(node);
                    body.insertBefore(para, inArea);
                }
            }
        }
        function sendToReduce(str)
        {
            console.log(str);   // For debugging...
            let buf = new Uint8Array(str.length+1);
            for (let i=0; i<str.length; i++)
                buf[i] = str.charCodeAt(i);
            buf[str.length] = 0; // nul-terminate for benefit of C/C++.
            worker.postMessage({
                funcName: 'insert_buffer',
                callbackId: '',
                data: buf
            });
        }
        button.addEventListener('click', event => {
            // need to convert the string to a Uint8Array
            let str = unescape(encodeURIComponent(inArea.value));
            // found the above snippet at https://gist.github.com/emrahgunduz/5c27ff1db650b93c7864
// Insert the input text so that people can see it...
            var para = document.createElement("P");//make an p element
            var node = document.createTextNode(str);//create an innerHTML node
            para.appendChild(node);//add the text to the p element
            var body = document.getElementById("theBody");
            body.insertBefore(para, inArea);
            let buf = new Uint8Array(str.length+1);
            for (let i=0; i<str.length; i++)
                buf[i] = str.charCodeAt(i);
            buf[str.length] = 0; // nul-terminate for benefit of C/C++.
            worker.postMessage({
                funcName: 'insert_buffer',
                callbackId: '',
                data: buf
            });
        });
        document.addEventListener("DOMContentLoaded", function(event) {
            document.body.appendChild(inArea);
            document.body.appendChild(button);
        });
        sendToReduce('<< lisp (!*redefmsg := nil); load_package tmprint; on nat; on fancy; off promptnumbers; on redfront_mode >>$');
    </script>
</head>

<body id="theBody">

<!--
   <math-field>f(x)=
   </math-field>
-->

</p>

</body>
</html>
